<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°≈ô objedn√°vky</title>
	
	 <link rel="stylesheet" href="css/stylek.css">
	
	
	
	
</head>
<body>
    <!-- Hlavn√≠ obsah str√°nky, kter√Ω bude v≈ædy zobrazen -->
    <div id="main-content">
        <div class="container" id="form-container">
            <!-- Tlaƒç√≠tko Zpƒõt na nab√≠dku - naho≈ôe -->
            <a href="specialobj.html" class="back-button">‚Üê Zpƒõt na nab√≠dku</a>
            
            <form id="myForm" action="#">
                <h1>Objedn√°vka <span id="current-order-display"></span> <span id="customer-name-display" class="customer-name-display"></span></h1>
                <div class="form-group jmeno-input-group">
                    <label for="jmeno">Jm√©no:<span class="required-asterisk">*</span></label>
                    <input type="text" id="jmeno" name="jmeno" value="" required>
                </div>

                <hr>
                <!-- Sekce pro zobrazen√≠ vybran√© polo≈æky -->
                <div class="selected-item-display" id="selected-item-display">
                    <img id="selected-item-image" src="" alt="Vybran√© j√≠dlo" style="display: none;">
                    <h4 id="selected-item-name"></h4>
                    <p id="selected-item-description"></p> <!-- NOVINKA: Popis zbo≈æ√≠ -->
                    <p id="selected-item-price"></p>
                </div>

                <div class="form-group hidden-form-group">
                    <label for="nazev-zbozi">N√°zev zbo≈æ√≠:</label>
                    <input type="text" id="nazev-zbozi" name="nazev-zbozi" value="" readonly>
                </div>
                <div class="form-group hidden-form-group">
                    <label for="pevna-cena-1">Pevn√° cena (Kƒç):</label>
                    <input type="number" id="pevna-cena-1" name="pevna-cena-1" value="120" readonly>
                </div>
                <div class="form-group">
                    <label for="kusy">Poƒçet kus≈Ø:</label>
                    <input type="number" id="kusy" name="kusy" value="1">
                </div>

                <!-- Sekce pro pozn√°mku k polo≈æce -->
                <div class="form-group">
                    <label for="polozka-poznamka">Pozn√°mka k polo≈æce (nap≈ô. bez cibule):</label>
                    <textarea id="polozka-poznamka" name="polozka-poznamka" rows="2" placeholder="Zde m≈Ø≈æete p≈ôidat pozn√°mku ke konkr√©tn√≠ polo≈æce..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="popis-objednavky">Pozn√°mka k objedn√°vce:</label>
                    <textarea id="popis-objednavky" name="popis-objednavky" rows="3" placeholder="Zde m≈Ø≈æete p≈ôidat speci√°ln√≠ po≈æadavky nebo pozn√°mky k objedn√°vce..."></textarea>
                </div>
                
                <div class="button-container">
                    <button type="button" id="spocitat-total">P≈ôidat do ko≈°√≠ku</button>
                    <button type="button" id="zobrazit-popover">Zobrazit ko≈°√≠k</button>
                    <!-- Tlaƒç√≠tko Zpƒõt na nab√≠dku - dole -->
                    <a href="specialobj.html" class="back-button">‚Üê Zpƒõt na nab√≠dku</a>
                </div>
            </form>
        </div>

        <!-- Popover, kter√Ω zobrazuje seznam a celkovou ƒç√°stku -->
        <div id="myPopover" class="popover">
            <!-- K≈ô√≠≈æek je p≈ô√≠mo uvnit≈ô popoveru -->
            <span class="close-popover-icon" title="Zav≈ô√≠t ko≈°√≠k">&times;</span> 
            <div class="popover-header"> <!-- Kontejner pro hlaviƒçku popoveru -->
                <h3 class="popover-title">Objedn√°vka #<span id="popover-cislo-objednavky"></span></h3>
            </div>
            <p class="popover-customer-name">Jm√©no: <span id="popover-jmeno-zakaznika"></span></p>
            <div id="popover-seznam-polozek" class="popover-content">
                <!-- Sem se budou dynamicky p≈ôid√°vat vypoƒçten√© polo≈æky -->
            </div>
            <p class="popover-total">Celkem: <span id="popover-celkova-suma">0.00 Kƒç</span></p>
            <p id="popover-order-description" class="popover-order-description" style="display: none;"></p>
			 
            <div class="popover-actions">
			
                <button class="print-button" id="print-popover-button">Objednat</button>
                <button class="close-button-popover">Zru≈°it objedn√°vku</button>
			</div>
			 <a href="specialobj.html" class="back-button">‚Üê Zpƒõt na nab√≠dku</a>
			
		</div>	
       </div>

        <!-- Univerz√°ln√≠ dialog (nahrazuje p≈Øvodn√≠ confirmationDialog) -->
        <div id="customDialog" class="custom-dialog">
            <p id="dialog-message"></p>
            <span id="dialog-emoji" class="dialog-emoji"></span> <!-- M√≠sto pro smajl√≠ka -->
            <div class="custom-dialog-actions">
                <button id="customDialogYes" class="yes">Ano</button>
                <button id="customDialogNo" class="no">Ne</button>
            </div>
        </div>
        <!-- Overlay pro dialog -->
        <div id="dialogOverlay" class="dialog-overlay"></div>

        <!-- Dƒõkovac√≠ dialog pro odesl√°n√≠ objedn√°vky -->
        <div id="thankYouDialog" class="thankYou-dialog" style="display: none;">
            <div class="thankYou-content">
                <p>Dƒõkujeme za objedn√°vku!</p>
            </div>
        </div>

        <!-- Zpr√°va o blokov√°n√≠ pop-up≈Ø (ji≈æ nepot≈ôebn√©, ale pone≈°eno pro konzistenci) -->
        <div id="popupBlockedMessage" class="popup-blocked-message" style="display: none;">
            Str√°nka pro tisk byla zablokov√°na prohl√≠≈æeƒçem. Pros√≠m, povolte vyskakovac√≠ okna pro tuto str√°nku.
        </div>
    

      <!-- Element pro vlastn√≠ tooltip -->
      <div id="customTooltip"></div>
	
<script>
        document.addEventListener('DOMContentLoaded', function() {
    // Funkce pro inicializaci zbytku logiky formul√°≈ôe
    function initializeFormLogic() {
        // Z√≠sk√°n√≠ element≈Ø z DOM pro formul√°≈ô
        const jmenoInput = document.getElementById('jmeno');
        const jmenoInputGroup = document.querySelector('.jmeno-input-group');
        const popisObjednavkyInput = document.getElementById('popis-objednavky');
        const polozkaPoznamkaInput = document.getElementById('polozka-poznamka');
        const nazevZbozi = document.getElementById('nazev-zbozi');
        const pevnaCena1 = document.getElementById('pevna-cena-1');
        const kusy = document.getElementById('kusy');
        const tlacitkoSpocitatTotal = document.getElementById('spocitat-total');
        const tlacitkoZobrazitPopover = document.getElementById('zobrazit-popover');

        // Z√≠sk√°n√≠ element≈Ø pro zobrazen√≠ vybran√© polo≈æky
        const selectedItemDisplay = document.getElementById('selected-item-display');
        const selectedItemImage = document.getElementById('selected-item-image');
        const selectedItemName = document.getElementById('selected-item-name');
        const selectedItemDescription = document.getElementById('selected-item-description'); 
        const selectedItemPrice = document.getElementById('selected-item-price');

        // Z√≠sk√°n√≠ element≈Ø z DOM pro popover
        const popover = document.getElementById('myPopover');
        const popoverCisloObjednavky = document.getElementById('popover-cislo-objednavky');
        const popoverJmenoZakaznika = document.getElementById('popover-jmeno-zakaznika');
        const popoverSeznamPolozek = document.getElementById('popover-seznam-polozek');
        const popoverCelkovaSuma = document.getElementById('popover-celkova-suma');
        const popoverOrderDescription = document.getElementById('popover-order-description');
        const closeButtonPopover = document.querySelector('.close-button-popover');
        const printButton = document.querySelector('.print-button');
        const closePopoverIcon = document.querySelector('.close-popover-icon');

        // Z√≠sk√°n√≠ element≈Ø pro univerz√°ln√≠ dialog
        const customDialog = document.getElementById('customDialog');
        const dialogMessage = document.getElementById('dialog-message');
        const customDialogYes = document.getElementById('customDialogYes');
        const customDialogNo = document.getElementById('customDialogNo');
        const dialogOverlay = document.getElementById('dialogOverlay');
        const dialogEmojiSpan = document.getElementById('dialog-emoji');

        // Z√≠sk√°n√≠ element≈Ø pro dƒõkovac√≠ dialog
        const thankYouDialog = document.getElementById('thankYouDialog');

        // Element pro zobrazen√≠ ƒç√≠sla objedn√°vky na hlavn√≠ str√°nce formul√°≈ôe
        const currentOrderDisplay = document.getElementById('current-order-display');
        const customerNameDisplay = document.querySelector('.customer-name-display');

        // Element: Vlastn√≠ tooltip
        const customTooltip = document.getElementById('customTooltip');

        // Glob√°ln√≠ pole pro ulo≈æen√≠ jednotliv√Ωch vypoƒçten√Ωch polo≈æek
        // ZMƒöNA: Pou≈æ√≠v√°me novou promƒõnnou pro intern√≠ pr√°ci, ale ukl√°d√°me pod 'cartItems'
        let cartItems = []; 
        // Promƒõnn√° pro ƒç√≠slo aktu√°ln√≠ objedn√°vky (null, dokud nen√≠ p≈ôid√°na prvn√≠ polo≈æka)
        let cisloObjednavky = null;

        // Funkce pro generov√°n√≠ n√°hodn√©ho ƒçty≈ôm√≠stn√©ho ƒç√≠sla
        function generateRandomFourDigitNumber() {
            return Math.floor(1000 + Math.random() * 9000);
        }

        // Funkce pro zobrazen√≠ univerz√°ln√≠ho dialogu
        function showCustomDialog(message, onConfirmCallback, onCancelCallback, showButtons = true) {
            dialogEmojiSpan.textContent = '';
            dialogEmojiSpan.classList.remove('pulsing');

            if (showButtons) {
                dialogMessage.textContent = message;
                customDialogYes.style.display = 'inline-block';
                customDialogNo.style.display = 'inline-block';
                customDialogYes.textContent = 'Ano';
                customDialogNo.textContent = 'Ne';
            } else {
                dialogMessage.textContent = '';
                dialogEmojiSpan.textContent = message;
                dialogEmojiSpan.classList.add('pulsing');
                customDialogYes.style.display = 'none';
                customDialogNo.style.display = 'none';
            }

            customDialog.style.display = 'block';
            dialogOverlay.style.display = 'block';

            // Odebere p≈ôedchoz√≠ listenery, aby se zabr√°nilo v√≠cen√°sobn√©mu spu≈°tƒõn√≠
            customDialogYes.onclick = null;
            customDialogNo.onclick = null;

            if (showButtons) {
                customDialogYes.onclick = function(event) {
                    event.stopPropagation();
                    hideCustomDialog();
                    if (onConfirmCallback) onConfirmCallback();
                };

                customDialogNo.onclick = function(event) {
                    event.stopPropagation();
                    hideCustomDialog();
                    if (onCancelCallback) onCancelCallback();
                };
            } else {
                // Pro dialog pouze se smajl√≠kem, skryje se po timeoutu
                setTimeout(() => {
                    hideCustomDialog();
                    setTimeout(() => {
                        if (onConfirmCallback) {
                            onConfirmCallback();
                        }
                    }, 50);
                }, 1500);
            }
        }

        // Funkce pro skryt√≠ univerz√°ln√≠ho dialogu
        function hideCustomDialog() {
            customDialog.style.display = 'none';
            dialogOverlay.style.display = 'none';
            dialogEmojiSpan.textContent = '';
            dialogEmojiSpan.classList.remove('pulsing');
        }

        // Funkce pro aktualizaci stavu tlaƒç√≠tek "P≈ôidat do ko≈°√≠ku" a "Zobrazit ko≈°√≠k"
        function aktualizovatStavTlacitkaSpocitat() {
            const isNazevZboziEmpty = nazevZbozi.value.trim() === '';
            const isJmenoProvided = jmenoInput.value.trim() !== '' || cisloObjednavky !== null;

            tlacitkoSpocitatTotal.disabled = isNazevZboziEmpty || !isJmenoProvided;
            tlacitkoZobrazitPopover.disabled = popover.style.display === 'flex' || isNazevZboziEmpty || !isJmenoProvided;
        }
		
		
		
		

        // Funkce pro zobrazen√≠ doƒçasn√© zpr√°vy (nyn√≠ jako "n√°lepka")
        function showTemporaryMessage(message, type = 'info', duration = 2000) { 
            let stickerDiv = document.getElementById('temporarySticker');
            if (!stickerDiv) {
                stickerDiv = document.createElement('div');
                stickerDiv.id = 'temporarySticker';
                stickerDiv.classList.add('temporary-sticker');
                document.body.appendChild(stickerDiv);
            }

            stickerDiv.textContent = message;
            stickerDiv.className = 'temporary-sticker';
            stickerDiv.classList.add(type);
            stickerDiv.classList.add('active');

            setTimeout(() => {
                stickerDiv.classList.remove('active');
                setTimeout(() => {
                    if (stickerDiv.parentNode) {
                        stickerDiv.parentNode.removeChild(stickerDiv);
                    }
                }, 400); 
            }, duration);
        }

        // Funkce pro aktualizaci popoveru
        function aktualizovatPopover() {
            popoverSeznamPolozek.innerHTML = '';
            popoverCisloObjednavky.textContent = cisloObjednavky;
            popoverJmenoZakaznika.textContent = localStorage.getItem('jmenoUzivatele') || '';

            let celkovaSuma = 0;

            cartItems.forEach((item, index) => { // ZMƒöNA: Iterujeme p≈ôes cartItems
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('popover-item-container');

                const detailsContainer = document.createElement('div');
                detailsContainer.classList.add('popover-item-details-container');

                const itemName = document.createElement('p');
                itemName.classList.add('popover-item-name');
                itemName.textContent = `${item.nazev}`;
                // P≈ôid√°n√≠ event listener≈Ø pro vlastn√≠ tooltip
                itemName.addEventListener('mouseover', function() {
                    customTooltip.textContent = item.nazev;
                    const rect = itemName.getBoundingClientRect();
                    // Upraven√° pozice Y pro tooltip (vy≈°≈°√≠ um√≠stƒõn√≠)
                    customTooltip.style.left = `${rect.left + window.scrollX}px`;
                    customTooltip.style.top = `${rect.top + window.scrollY - customTooltip.offsetHeight - 20}px`; 
                    customTooltip.style.display = 'block';
                });
                itemName.addEventListener('mouseout', function() {
                    customTooltip.style.display = 'none';
                });


                const itemDetails = document.createElement('p');
                itemDetails.classList.add('popover-item-details');
                itemDetails.textContent = `${item.kusy} ks x ${item.cena.toFixed(2)} Kƒç = ${item.total.toFixed(2)} Kƒç`;

                detailsContainer.appendChild(itemName);
                detailsContainer.appendChild(itemDetails);

                // Zobrazen√≠ pozn√°mky k polo≈æce, pokud existuje
                if (item.polozkaPoznamka && item.polozkaPoznamka.trim() !== '') {
                    const itemNote = document.createElement('p');
                    itemNote.classList.add('popover-item-note');
                    itemNote.textContent = `Pozn√°mka: ${item.polozkaPoznamka}`;
                    detailsContainer.appendChild(itemNote);
                }

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.innerHTML = '&times;';
                deleteButton.title = 'Odstranit polo≈æku';
                deleteButton.addEventListener('click', function() {
                    // Zobraz√≠ potvrzovac√≠ dialog p≈ôed smaz√°n√≠m
                    showCustomDialog(`Opravdu chcete odebrat polo≈æku "${item.nazev}"?`,
                        () => { // On Confirm (Ano)
                            // Maz√°n√≠ po kusech
                            if (item.kusy > 1) {
                                item.kusy--;
                                item.total -= item.cena;
                                showTemporaryMessage(`Odebr√°n 1 kus z "${item.nazev}".`, 'info', 2000);
                            } else {
                                cartItems.splice(index, 1); // ZMƒöNA: Odstra≈àujeme z cartItems
                                showTemporaryMessage(`Polo≈æka "${item.nazev}" odebr√°na.`, 'info', 2000);
                            }
                            localStorage.setItem('cartItems', JSON.stringify(cartItems)); // ZMƒöNA: Ukl√°d√°me cartItems
                            console.log(`[formular.html] cartItems po smaz√°n√≠/√∫pravƒõ:`, JSON.parse(localStorage.getItem('cartItems'))); // Log pro ladƒõn√≠
                            if (cartItems.length === 0) { // ZMƒöNA: Kontrolujeme cartItems
                                localStorage.removeItem('cisloObjednavky');
                                cisloObjednavky = null;
                                localStorage.removeItem('cartItems'); // ZMƒöNA: Odstran√≠me i cartItems
                                console.log("[formular.html] Ko≈°√≠k pr√°zdn√Ω, cartItems odstranƒõno z localStorage.");
                            }
                            aktualizovatPopover();
                            updateNameDisplay();
                            aktualizovatStavTlacitkaSpocitat();
                        },
                        () => { // On Cancel (Ne)
                            showTemporaryMessage('Odebr√°n√≠ polo≈æky zru≈°eno.', 'info', 1500);
                        },
                        true
                    );
                });

                itemContainer.appendChild(detailsContainer);
                itemContainer.appendChild(deleteButton);
                popoverSeznamPolozek.appendChild(itemContainer);

                celkovaSuma += item.total;
            });

            popoverCelkovaSuma.textContent = celkovaSuma.toFixed(2) + " Kƒç";

            const popisObjednavky = localStorage.getItem('popisObjednavky');
            if (popisObjednavky && popisObjednavky.trim() !== '') {
                popoverOrderDescription.textContent = `Pozn√°mka: ${popisObjednavky}`;
                popoverOrderDescription.style.display = 'block';
            } else {
                popoverOrderDescription.textContent = '';
                popoverOrderDescription.style.display = 'none';
            }

            // Logika pro zobrazen√≠/skryt√≠ popoveru
            if (cartItems.length > 0 || (popisObjednavky && popisObjednavky.trim() !== '')) { // ZMƒöNA: Kontrolujeme cartItems
                popover.style.display = 'flex';
                tlacitkoZobrazitPopover.disabled = true;
            } else {
                popover.style.display = 'none';
                tlacitkoZobrazitPopover.disabled = false;
            }

            // Speci√°ln√≠ p≈ô√≠pad: pokud je ko≈°√≠k pr√°zdn√Ω a nen√≠ ≈æ√°dn√° celkov√° pozn√°mka, popover skryj
            if (cartItems.length === 0 && (popisObjednavky === null || popisObjednavky.trim() === '')) { // ZMƒöNA: Kontrolujeme cartItems
                popover.style.display = 'none';
                tlacitkoZobrazitPopover.disabled = false;
            }

            // Aktualizace ƒç√≠sla objedn√°vky na hlavn√≠ str√°nce formul√°≈ôe
            currentOrderDisplay.textContent = cisloObjednavky ? `${cisloObjednavky}` : '';
        }

        // Funkce pro zobrazen√≠/skryt√≠ pole jm√©na a jm√©na v nadpisu
        function updateNameDisplay() {
            const currentJmeno = jmenoInput.value.trim();
            const hasOrder = cisloObjednavky !== null;
            const storedJmeno = localStorage.getItem('jmenoUzivatele');
            const nameToDisplay = storedJmeno || currentJmeno;

            if (hasOrder && nameToDisplay !== '') {
                jmenoInputGroup.style.display = 'none';
                jmenoInput.disabled = true;
                customerNameDisplay.textContent = nameToDisplay;
                customerNameDisplay.style.display = 'inline';
            } else {
                jmenoInputGroup.style.display = 'block';
                jmenoInput.disabled = false;
                customerNameDisplay.textContent = '';
                customerNameDisplay.style.display = 'none';
            }
            aktualizovatStavTlacitkaSpocitat();
        }

        // Funkce pro vynulov√°n√≠ v≈°ech hodnot (cel√© objedn√°vky)
        function resetovatVse() {
            cartItems = []; // ZMƒöNA: Vynulujeme cartItems
            cisloObjednavky = null;
            popoverSeznamPolozek.innerHTML = '';
            popoverCelkovaSuma.textContent = "0.00 Kƒç";
            popover.style.display = 'none';
            popoverCisloObjednavky.textContent = '';
            currentOrderDisplay.textContent = '';
            
            localStorage.removeItem('cartItems'); // ZMƒöNA: Odstran√≠me 'cartItems'
            localStorage.removeItem('cisloObjednavky');
            localStorage.removeItem('jmenoUzivatele');
            localStorage.removeItem('popisObjednavky');
            
            console.log("[formular.html] V≈°e vynulov√°no, localStorage vyƒçi≈°tƒõno."); // Log pro ladƒõn√≠

            jmenoInput.value = "";
            popisObjednavkyInput.value = "";
            polozkaPoznamkaInput.value = "";
            nazevZbozi.value = "";
            pevnaCena1.value = "120";
            kusy.value = "1";

            selectedItemDisplay.style.display = 'none';
            selectedItemImage.src = '';
            selectedItemImage.style.display = 'none';
            selectedItemName.textContent = '';
            selectedItemDescription.textContent = ''; // Vyƒçist√≠ popis
            selectedItemPrice.textContent = '';

            updateNameDisplay();
            if (jmenoInputGroup.style.display !== 'none') {
                jmenoInput.focus();
            } else {
                kusy.focus();
            }
        }

        // Funkce pro zpracov√°n√≠ kliknut√≠ na tlaƒç√≠tko v√Ωpoƒçtu
        tlacitkoSpocitatTotal.addEventListener('click', function(event) {
            event.stopPropagation();

            if (jmenoInputGroup.style.display !== 'none' && jmenoInput.value.trim() === '') {
                showTemporaryMessage('Pros√≠m, vypl≈àte jm√©no z√°kazn√≠ka.', 'warning');
                jmenoInput.focus();
                return;
            }

            const nazev = nazevZbozi.value || "Nezn√°m√© zbo≈æ√≠";
            const cena = parseFloat(pevnaCena1.value);
            const pocetKusu = parseFloat(kusy.value);
            const itemNote = polozkaPoznamkaInput.value.trim();
            const itemDescription = selectedItemDescription.textContent.trim(); // Z√≠sk√° popis

            if (isNaN(cena) || isNaN(pocetKusu) || pocetKusu <= 0) {
                showTemporaryMessage('Pros√≠m zadejte platn√© ƒç√≠slo pro poƒçet kus≈Ø.', 'warning');
                return;
            }

            const existingItemIndex = cartItems.findIndex(item => item.nazev === nazev); // ZMƒöNA: Hled√°me v cartItems

            if (existingItemIndex > -1) {
                let message = `Polo≈æka "${nazev}" je ji≈æ v ko≈°√≠ku. Poƒçet kus≈Ø se nav√Ω≈°√≠ o ${pocetKusu}. Chcete pokraƒçovat?`;

                showCustomDialog(message,
                    () => { // On Confirm (Ano)
                        addItemConfirmed(nazev, cena, pocetKusu, existingItemIndex, itemNote, itemDescription); 
                    },
                    () => { // On Cancel (Ne)
                        showTemporaryMessage('P≈ôid√°n√≠ polo≈æky zru≈°eno.', 'info', 1500);
                    },
                    true
                );
            } else {
                addItemConfirmed(nazev, cena, pocetKusu, -1, itemNote, itemDescription); 
            }
        });

        // Pomocn√° funkce, kter√° zapouzd≈ôuje skuteƒçnou logiku p≈ôid√°v√°n√≠
        function addItemConfirmed(nazev, cena, pocetKusu, existingItemIndex, itemNote, itemDescription) { 
            if (cartItems.length === 0) { // ZMƒöNA: Kontrolujeme cartItems
                cisloObjednavky = generateRandomFourDigitNumber();
                localStorage.setItem('cisloObjednavky', cisloObjednavky);
                localStorage.setItem('jmenoUzivatele', jmenoInput.value.trim());
            }
            const novyTotal = cena * pocetKusu;

            if (existingItemIndex > -1) {
                cartItems[existingItemIndex].kusy += pocetKusu; // ZMƒöNA: Mƒõn√≠me cartItems
                cartItems[existingItemIndex].total += novyTotal; // ZMƒöNA: Mƒõn√≠me cartItems
                cartItems[existingItemIndex].polozkaPoznamka = itemNote; 
                cartItems[existingItemIndex].popisZbozi = itemDescription; 
                
                showTemporaryMessage(`Polo≈æka "${nazev}" aktualizov√°na.`, 'info', 2000);
            } else {
                cartItems.push({ // ZMƒöNA: P≈ôid√°v√°me do cartItems
                    nazev: nazev,
                    cena: cena,
                    kusy: pocetKusu,
                    total: novyTotal,
                    polozkaPoznamka: itemNote,
                    popisZbozi: itemDescription 
                });
                showTemporaryMessage('üëç', 'info', 2000);
            }
            
            localStorage.setItem('cartItems', JSON.stringify(cartItems)); // ZMƒöNA: Ukl√°d√°me 'cartItems'
            console.log(`[formular.html] Polo≈æka p≈ôid√°na/aktualizov√°na, cartItems v localStorage:`, JSON.parse(localStorage.getItem('cartItems'))); // Log pro ladƒõn√≠

            updateNameDisplay();
            aktualizovatPopover();
            polozkaPoznamkaInput.value = ''; // Vyma≈æe pole pozn√°mky po P≈òID√ÅN√ç/AKTUALIZACI polo≈æky
        }

        // Zobraz√≠ popover po kliknut√≠ na tlaƒç√≠tko "Zobrazit seznam"
        tlacitkoZobrazitPopover.addEventListener('click', function(event) {
            event.stopPropagation();

            if (jmenoInputGroup.style.display !== 'none' && jmenoInput.value.trim() === '') {
                showTemporaryMessage('Pros√≠m, vypl≈àte jm√©no z√°kazn√≠ka.', 'warning');
                jmenoInput.focus();
                return;
            }

            // *** NOV√Å LOGIKA PRO AKTUALIZACI POZN√ÅMKY P≈òED ZOBRAZEN√çM KO≈†√çKU (POZN√ÅMKA Z≈ÆST√ÅV√Å) ***
            const currentSelectedItemName = nazevZbozi.value.trim();
            const currentItemNote = polozkaPoznamkaInput.value.trim();

            if (currentSelectedItemName !== '') {
                const existingItemIndex = cartItems.findIndex(item => item.nazev === currentSelectedItemName); // ZMƒöNA: Hled√°me v cartItems
                if (existingItemIndex > -1) {
                    // Aktualizuje pozn√°mku u existuj√≠c√≠ polo≈æky v poli ko≈°√≠ku
                    cartItems[existingItemIndex].polozkaPoznamka = currentItemNote; // ZMƒöNA: Mƒõn√≠me cartItems
                    // Okam≈æitƒõ ulo≈æ√≠ do localStorage
                    localStorage.setItem('cartItems', JSON.stringify(cartItems)); // ZMƒöNA: Ukl√°d√°me 'cartItems'
                    console.log(`[formular.html] Polo≈æka v ko≈°√≠ku aktualizov√°na (pozn√°mka), cartItems v localStorage:`, JSON.parse(localStorage.getItem('cartItems'))); // Log pro ladƒõn√≠
                }
            }
            // *** KONEC NOV√â LOGIKY ***

            if (popover.style.display === 'flex') {
                popover.style.display = 'none';
                tlacitkoZobrazitPopover.disabled = false;
            } else {
                aktualizovatPopover(); // Zde se ko≈°√≠k aktualizuje, kdy≈æ se zobrazuje
                popover.style.display = 'flex';
                tlacitkoZobrazitPopover.disabled = true;
            }
        });

        // Funkce pro odesl√°n√≠ popoveru k tisku
        printButton.addEventListener('click', function() {
            window.print();
            thankYouDialog.style.display = 'flex';
            setTimeout(() => {
                thankYouDialog.style.display = 'none';
                resetovatVse();
                // P≈ôesmƒõrov√°n√≠ na str√°nku special.html po dokonƒçen√≠ objedn√°vky
                window.location.href = 'specialobj.html';
            }, 2000);
        });

        // Zav≈ôe popover a vynuluje objedn√°vku (Zobraz√≠ potvrzovac√≠ dialog)
        closeButtonPopover.addEventListener('click', function() {
            popover.style.display = 'none';
            tlacitkoZobrazitPopover.disabled = false;

            showCustomDialog('V√°≈ænƒõ chcete zru≈°it objedn√°vku?',
                () => { // onConfirm (Ano) pro prvn√≠ dialog
                    showCustomDialog('üò¢', null, null, false);
                    setTimeout(() => {
                        resetovatVse();
                        window.location.href = 'specialobj.html';
                    }, 1500 + 50);
                },
                () => { // onCancel (Ne) pro prvn√≠ dialog
                    showCustomDialog('üòä', null, null, false);
                    setTimeout(() => {
                        tlacitkoZobrazitPopover.disabled = false;
                    }, 1500 + 50);
                },
                true
            );
        });

        // Zav≈ôe popover, ale NENULuje objedn√°vku (pomoc√≠ k≈ô√≠≈æku)
        if (closePopoverIcon) {
            closePopoverIcon.addEventListener('click', function() {
                popover.style.display = 'none';
                tlacitkoZobrazitPopover.disabled = false;
            });
        }

        // Skryje popover po kliknut√≠ kdekoli na str√°nce mimo popover
        document.addEventListener('click', function(event) {
            const isClickInsidePopover = popover.contains(event.target);
            const isClickOnTriggerButton = (tlacitkoSpocitatTotal && tlacitkoSpocitatTotal.contains(event.target)) || (tlacitkoZobrazitPopover && tlacitkoZobrazitPopover.contains(event.target));
            const isClickOnDeleteButton = event.target.classList.contains('delete-button');
            const isClickInsideCustomDialog = customDialog.contains(event.target);
            const isCustomDialogVisible = customDialog.style.display === 'block';
            const isClickInsideThankYouDialog = thankYouDialog.contains(event.target);
            const isThankYouDialogVisible = thankYouDialog.style.display === 'flex';
            const isClickOnCloseIcon = closePopoverIcon && closePopoverIcon.contains(event.target);


            if (
                popover.style.display === 'flex' &&
                !isClickInsidePopover &&
                !isClickOnTriggerButton &&
                !isClickOnDeleteButton &&
                !(isCustomDialogVisible && isClickInsideCustomDialog) &&
                !(isThankYouDialogVisible && isClickInsideThankYouDialog) &&
                !isClickOnCloseIcon
            ) {
                popover.style.display = 'none';
                tlacitkoZobrazitPopover.disabled = false;
            }
        });

        // Funkce pro naƒçten√≠ dat z URL parametr≈Ø
        function loadDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const img = urlParams.get('img');
            const name = urlParams.get('name');
            const price = urlParams.get('price');
            const description = urlParams.get('description'); 

            if (img) {
                selectedItemImage.src = img;
                selectedItemImage.style.display = 'block';
            } else {
                selectedItemImage.style.display = 'none';
            }
            if (name) {
                selectedItemName.textContent = name;
                nazevZbozi.value = name;

                const existingItem = cartItems.find(item => item.nazev === name); // ZMƒöNA: Hled√°me v cartItems
                if (existingItem && existingItem.polozkaPoznamka) {
                    polozkaPoznamkaInput.value = existingItem.polozkaPoznamka;
                } else {
                    polozkaPoznamkaInput.value = ''; 
                }

            } else {
                polozkaPoznamkaInput.value = ''; 
            }
            if (price) {
                selectedItemPrice.textContent = `${parseFloat(price).toFixed(2)} Kƒç`;
                pevnaCena1.value = parseFloat(price);
            }
            
            // Zobraz√≠ popis, pokud je k dispozici (pouze ve formul√°≈ôi)
            if (description) {
                selectedItemDescription.textContent = description;
                selectedItemDescription.style.display = 'block';
            } else {
                selectedItemDescription.textContent = '';
                selectedItemDescription.style.display = 'none';
            }
            
            if (window.location.protocol !== 'blob:') {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // P≈ôi naƒçten√≠ str√°nky se pokus√≠me naƒç√≠st existuj√≠c√≠ objedn√°vku z localStorage
        const storedCartItems = localStorage.getItem('cartItems'); // ZMƒöNA: Naƒç√≠t√°me 'cartItems'
        if (storedCartItems) {
            try {
                cartItems = JSON.parse(storedCartItems); // ZMƒöNA: Parsujeme do cartItems
                console.log("[formular.html] Naƒçten√© cartItems z localStorage:", cartItems); // Log pro ladƒõn√≠
            } catch (e) {
                console.error("[formular.html] Chyba p≈ôi parsov√°n√≠ cartItems z localStorage:", e); // Log pro ladƒõn√≠
                cartItems = [];
            }
        } else {
            console.log("[formular.html] ≈Ω√°dn√© cartItems v localStorage nalezeny."); // Log pro ladƒõn√≠
        }

        const storedCisloObjednavky = localStorage.getItem('cisloObjednavky');
        if (storedCisloObjednavky) {
            cisloObjednavky = parseInt(storedCisloObjednavky, 10);
        }

        // Naƒçten√≠ jm√©na z localStorage p≈ôi naƒçten√≠ str√°nky
        const storedJmeno = localStorage.getItem('jmenoUzivatele');
        if (storedJmeno) {
            jmenoInput.value = storedJmeno;
        }
        
        // Naƒçten√≠ popisu objedn√°vky z localStorage p≈ôi naƒçten√≠ str√°nky
        const storedPopisObjednavky = localStorage.getItem('popisObjednavky');
        if (storedPopisObjednavky) {
            popisObjednavkyInput.value = storedPopisObjednavky;
        }

        // Ukl√°d√°n√≠ jm√©na do localStorage p≈ôi ka≈æd√© zmƒõnƒõ pole
        jmenoInput.addEventListener('input', function() {
            localStorage.setItem('jmenoUzivatele', jmenoInput.value);
            aktualizovatStavTlacitkaSpocitat();
        });

        // Ukl√°d√°n√≠ popisu objedn√°vky do localStorage p≈ôi ka≈æd√© zmƒõnƒõ pole
        popisObjednavkyInput.addEventListener('input', function() {
            localStorage.setItem('popisObjednavky', popisObjednavkyInput.value);
            // Nen√≠ pot≈ôeba aktualizovat stav tlaƒç√≠tek zde, proto≈æe to neovliv≈àuje jejich aktivaci
        });


        // Spustit funkci pro naƒçten√≠ dat z URL (pouze po naƒçten√≠ DOM)
        loadDataFromUrl();
        // Spustit aktualizaci stavu tlaƒç√≠tek, aby se hned na zaƒç√°tku zkontroloval stav
        aktualizovatStavTlacitkaSpocitat();
        // Aktualizovat jm√©no z√°kazn√≠ka v nadpisu (a skr√Ωt input)
        updateNameDisplay();
        // Aktualizovat popover, pokud u≈æ existuj√≠ polo≈æky z localStorage
        aktualizovatPopover();
    }

    // P≈ôed spu≈°tƒõn√≠m logiky formul√°≈ôe zkontrolujte a vyma≈æte star√© kl√≠ƒçe, pokud existuj√≠
    // Tuto ƒç√°st m≈Ø≈æete po prvn√≠m spu≈°tƒõn√≠ odstranit, je to jen pro jednor√°zovou migraci
    if (localStorage.getItem('seznamPolozek')) {
        console.warn("[formular.html] Detekov√°n star√Ω kl√≠ƒç 'seznamPolozek'. Migruji na 'cartItems' a odstra≈àuji star√Ω kl√≠ƒç.");
        localStorage.setItem('cartItems', localStorage.getItem('seznamPolozek'));
        localStorage.removeItem('seznamPolozek');
    }

    initializeFormLogic();
});
    </script>
</body>
</html>

</body>
</html>

 